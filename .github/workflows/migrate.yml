name: migrate

on:
  workflow_dispatch:
    inputs:
      web_image:
        description: "Optional image override (for example ghcr.io/<owner>/<repo>:sha-<sha>)"
        required: false
        default: ""
      restart_web:
        description: "Restart the web service after migrations"
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  id-token: write
  packages: read

jobs:
  migrate:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-hetzner-production
      cancel-in-progress: false
    steps:
      - name: Fetch required deploy secrets from Vault (OIDC)
        id: vault_deploy
        if: ${{ vars.VAULT_ADDR != '' && vars.VAULT_ROLE != '' }}
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ vars.VAULT_ADDR }}
          namespace: ${{ vars.VAULT_NAMESPACE }}
          method: jwt
          path: ${{ vars.VAULT_AUTH_PATH || 'jwt' }}
          role: ${{ vars.VAULT_ROLE }}
          jwtGithubAudience: ${{ vars.VAULT_GITHUB_AUDIENCE || format('https://github.com/{0}', github.repository_owner) }}
          secrets: |
            ${{ vars.VAULT_SECRET_PATH || 'secret/data/pixelating/web/deploy' }} host | HOST ;
            ${{ vars.VAULT_SECRET_PATH || 'secret/data/pixelating/web/deploy' }} username | USERNAME ;
            ${{ vars.VAULT_SECRET_PATH || 'secret/data/pixelating/web/deploy' }} ssh_private_key | KEY ;
            ${{ vars.VAULT_SECRET_PATH || 'secret/data/pixelating/web/deploy' }} ssh_port | PORT ;

      - name: Report secret source
        env:
          VAULT_ENABLED: ${{ vars.VAULT_ADDR != '' && vars.VAULT_ROLE != '' && 'true' || 'false' }}
          HOST_SOURCE: ${{ steps.vault_deploy.outputs.HOST != '' && 'vault' || (secrets.HOST != '' && 'github' || 'missing') }}
          USERNAME_SOURCE: ${{ steps.vault_deploy.outputs.USERNAME != '' && 'vault' || (secrets.USERNAME != '' && 'github' || 'missing') }}
          KEY_SOURCE: ${{ steps.vault_deploy.outputs.KEY != '' && 'vault' || (secrets.KEY != '' && 'github' || 'missing') }}
          PORT_SOURCE: ${{ steps.vault_deploy.outputs.PORT != '' && 'vault' || (secrets.PORT != '' && 'github' || 'missing') }}
        run: |
          set -euo pipefail
          echo "Vault enabled: ${VAULT_ENABLED}"
          echo "HOST source: ${HOST_SOURCE}"
          echo "USERNAME source: ${USERNAME_SOURCE}"
          echo "KEY source: ${KEY_SOURCE}"
          echo "PORT source: ${PORT_SOURCE}"

          {
            echo "### Migrate secret source summary"
            echo "- Vault configured: \`${VAULT_ENABLED}\`"
            echo "- HOST: \`${HOST_SOURCE}\`"
            echo "- USERNAME: \`${USERNAME_SOURCE}\`"
            echo "- KEY: \`${KEY_SOURCE}\`"
            echo "- PORT: \`${PORT_SOURCE}\`"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Validate required secrets
        env:
          HOST: ${{ steps.vault_deploy.outputs.HOST || secrets.HOST }}
          USERNAME: ${{ steps.vault_deploy.outputs.USERNAME || secrets.USERNAME }}
          KEY: ${{ steps.vault_deploy.outputs.KEY || secrets.KEY }}
          HOST_SOURCE: ${{ steps.vault_deploy.outputs.HOST != '' && 'vault' || (secrets.HOST != '' && 'github' || 'missing') }}
          USERNAME_SOURCE: ${{ steps.vault_deploy.outputs.USERNAME != '' && 'vault' || (secrets.USERNAME != '' && 'github' || 'missing') }}
          KEY_SOURCE: ${{ steps.vault_deploy.outputs.KEY != '' && 'vault' || (secrets.KEY != '' && 'github' || 'missing') }}
          REQUIRE_VAULT_SECRETS: ${{ vars.REQUIRE_VAULT_SECRETS }}
        run: |
          set -euo pipefail
          missing=0
          if [ -z "${HOST:-}" ]; then
            echo "::error::Missing HOST (source=${HOST_SOURCE}). Set Vault key 'host' or GitHub secret HOST."
            missing=1
          fi
          if [ -z "${USERNAME:-}" ]; then
            echo "::error::Missing USERNAME (source=${USERNAME_SOURCE}). Set Vault key 'username' or GitHub secret USERNAME."
            missing=1
          fi
          if [ -z "${KEY:-}" ]; then
            echo "::error::Missing KEY (source=${KEY_SOURCE}). Set Vault key 'ssh_private_key' or GitHub secret KEY."
            missing=1
          fi
          if [ "${missing}" -ne 0 ]; then
            exit 1
          fi

          if [ "${REQUIRE_VAULT_SECRETS:-false}" = "true" ]; then
            if [ "${HOST_SOURCE}" != "vault" ] || [ "${USERNAME_SOURCE}" != "vault" ] || [ "${KEY_SOURCE}" != "vault" ]; then
              echo "::error::REQUIRE_VAULT_SECRETS=true, but one or more required migrate secrets came from fallback sources."
              echo "::error::Sources: HOST=${HOST_SOURCE} USERNAME=${USERNAME_SOURCE} KEY=${KEY_SOURCE}"
              exit 1
            fi
          fi

      - name: Configure SSH
        env:
          HOST: ${{ steps.vault_deploy.outputs.HOST || secrets.HOST }}
          PORT: ${{ steps.vault_deploy.outputs.PORT || secrets.PORT }}
          KEY: ${{ steps.vault_deploy.outputs.KEY || secrets.KEY }}
        run: |
          set -euo pipefail
          SSH_PORT="${PORT:-22}"

          install -d -m 700 ~/.ssh
          if printf '%s' "${KEY}" | grep -q '\\n'; then
            printf '%b' "${KEY}" > ~/.ssh/id_ed25519
          else
            printf '%s\n' "${KEY}" > ~/.ssh/id_ed25519
          fi
          tr -d '\r' < ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.tmp
          mv ~/.ssh/id_ed25519.tmp ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keygen -y -f ~/.ssh/id_ed25519 >/dev/null

          ssh-keyscan -T 15 -p "${SSH_PORT}" -H "${HOST}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Validate SSH authentication
        env:
          HOST: ${{ steps.vault_deploy.outputs.HOST || secrets.HOST }}
          PORT: ${{ steps.vault_deploy.outputs.PORT || secrets.PORT }}
          USERNAME: ${{ steps.vault_deploy.outputs.USERNAME || secrets.USERNAME }}
        run: |
          set -euo pipefail
          SSH_PORT="${PORT:-22}"
          ssh -i ~/.ssh/id_ed25519 -p "${SSH_PORT}" \
            -o BatchMode=yes \
            -o IdentitiesOnly=yes \
            -o PreferredAuthentications=publickey \
            -o PasswordAuthentication=no \
            -o StrictHostKeyChecking=yes \
            "${USERNAME}@${HOST}" "echo 'SSH authentication successful'"

      - name: Run migrations on server
        env:
          HOST: ${{ steps.vault_deploy.outputs.HOST || secrets.HOST }}
          PORT: ${{ steps.vault_deploy.outputs.PORT || secrets.PORT }}
          USERNAME: ${{ steps.vault_deploy.outputs.USERNAME || secrets.USERNAME }}
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}
          DEPLOY_COMPOSE_FILE: ${{ vars.DEPLOY_COMPOSE_FILE }}
          WEB_IMAGE_OVERRIDE: ${{ inputs.web_image }}
          RESTART_WEB: ${{ inputs.restart_web }}
          GHCR_USERNAME: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          SSH_PORT="${PORT:-22}"
          APP_DIR="${DEPLOY_PATH:-/var/www/web}"
          COMPOSE_FILE="${DEPLOY_COMPOSE_FILE:-production.yml}"

          ssh -i ~/.ssh/id_ed25519 -p "${SSH_PORT}" \
            -o BatchMode=yes \
            -o IdentitiesOnly=yes \
            -o PreferredAuthentications=publickey \
            -o PasswordAuthentication=no \
            -o StrictHostKeyChecking=yes \
            "${USERNAME}@${HOST}" \
            "APP_DIR='${APP_DIR}' COMPOSE_FILE='${COMPOSE_FILE}' WEB_IMAGE_OVERRIDE='${WEB_IMAGE_OVERRIDE}' RESTART_WEB='${RESTART_WEB}' GHCR_USERNAME='${GHCR_USERNAME}' GHCR_TOKEN='${GHCR_TOKEN}' bash -se" <<'REMOTE'
          set -euo pipefail

          cd "${APP_DIR}"
          if [ ! -f "${COMPOSE_FILE}" ]; then
            echo "Compose file not found: ${APP_DIR}/${COMPOSE_FILE}" >&2
            exit 1
          fi

          if [ -n "${GHCR_TOKEN:-}" ]; then
            printf '%s' "${GHCR_TOKEN}" | docker login ghcr.io -u "${GHCR_USERNAME}" --password-stdin
          fi

          docker compose -f "${COMPOSE_FILE}" up -d postgres

          if [ -n "${WEB_IMAGE_OVERRIDE:-}" ]; then
            WEB_IMAGE="${WEB_IMAGE_OVERRIDE}" docker compose -f "${COMPOSE_FILE}" pull web
            WEB_IMAGE="${WEB_IMAGE_OVERRIDE}" docker compose -f "${COMPOSE_FILE}" run --rm --no-deps web bun run migrate
          else
            docker compose -f "${COMPOSE_FILE}" run --rm --no-deps web bun run migrate
          fi

          if [ "${RESTART_WEB}" = "true" ]; then
            if [ -n "${WEB_IMAGE_OVERRIDE:-}" ]; then
              WEB_IMAGE="${WEB_IMAGE_OVERRIDE}" docker compose -f "${COMPOSE_FILE}" up -d web
            else
              docker compose -f "${COMPOSE_FILE}" up -d web
            fi
          fi

          docker compose -f "${COMPOSE_FILE}" ps

          if [ -n "${GHCR_TOKEN:-}" ]; then
            docker logout ghcr.io || true
          fi
          REMOTE
